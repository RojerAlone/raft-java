# 代码结构

- raft-java-admin 集群管理
- raft-java-core 核心实现
- raft-java-example kv 实现

# 技术栈

- RPC: brpc
- Store: 日志使用自定义存储结构，实现见 `SegmentedLog` 类

# 实现

## 投票

为了防止网络分区，导致分区内的实例一直递增 term，将投票拆分为了两阶段投票：

- preVote 阶段的 term 为当前 term，只有 preVote 成功后（过半接受）才会递增 term 并执行正式投票
- requestVote 为正式投票，投票成功变更为 leader 并执行职责

投票成功后，开始同步 log 并且开始周期发送心跳。

## 日志同步

根据论文描述，日志同步发生在两个地方，新 leader 被选举和客户端请求状态机变更，如果失败了的话就会一直重试，直到 follower 和自己的日志同步。

我自己在实现的时候，将心跳作为了纯粹的心跳，并没有同时作为日志同步的请求，而是在 leader 选举成功后复制日志时，一直尝试同步日志，直到 
follower 和自己日志同步，而这个项目中作者的实现是在每次心跳时不仅仅是心跳，也同步日志，是我自己理解的有问题。

即：每次同步日志失败了，不在本次同步日志操作中重试，而是修改存储的状态信息，下次心跳时候使用更正后的 follower 信息同步日志。

### 选举成功后

选举成功后 leader 要向 follower 同步自己的日志，第一次同步，只需要发送一次同步日志请求就行了，不管成功失败，都将当前记录的 follower 信息
修改，等待下一次心跳或者状态机变更时，使用更正的 follower 信息同步日志。

### 状态机变更

客户端发起请求，变更状态机状态，要将这个变更复制到所有 follower。
